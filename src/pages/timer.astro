---
import Layout from "@layouts/Layout.astro";
import "@styles/timer.css";
---

<Layout>
  <main id="main-content" class="h-screen w-full">
    <section id="timer" class="h-full w-full flex flex-col">
      <div id="controls">
        <div id="theme-switch-container" style="display: inline-block;">
          <button id="theme-switch" class="rounded border px-4 py-2">ğŸŒ</button>
        </div>
        <div id="variant-controls">
          <div id="segmented-control" role="group" aria-label="Timer variant">
            <button id="variant-fixed" class="segment active" aria-pressed="true">â±ï¸ Fixed</button>
            <button id="variant-target" class="segment" aria-pressed="false">ğŸ Target</button>
          </div>
        </div>
        <div id="inline-settings">
          <div id="fixed-settings">
            <div class="custom-dropdown" id="time-dropdown">
              <button type="button" class="dropdown-trigger" id="time-trigger">5 min</button>
              <div class="dropdown-menu" id="time-menu" hidden>
                <button type="button" class="dropdown-item" data-value="300">5 min</button>
                <button type="button" class="dropdown-item" data-value="600">10 min</button>
                <button type="button" class="dropdown-item" data-value="900">15 min</button>
                <button type="button" class="dropdown-item" data-value="1200">20 min</button>
                <button type="button" class="dropdown-item" data-value="custom">Custom</button>
              </div>
            </div>
            <input type="hidden" id="time-select" value="300" />
            <div id="custom-time-popover" role="dialog" aria-label="Custom time" hidden>
              <label for="custom-minutes">Minutes:</label>
              <input type="number" id="custom-minutes" placeholder="Minutes" min="1" max="999" />
              <button id="custom-time-ok">OK</button>
            </div>
          </div>
          <div id="target-settings" hidden>
            <input type="time" id="target-time" />
          </div>
          <div id="type-settings">
            <div class="custom-dropdown" id="type-dropdown">
              <button type="button" class="dropdown-trigger" id="type-trigger">â˜•ï¸ Break</button>
              <div class="dropdown-menu" id="type-menu" hidden>
                <button type="button" class="dropdown-item" data-value="break">â˜•ï¸ Break</button>
                <button type="button" class="dropdown-item" data-value="lab">ğŸ§‘â€ğŸ”¬ Lab</button>
                <button type="button" class="dropdown-item" data-value="session">ğŸ“ Session</button>
                <button type="button" class="dropdown-item" data-value="custom">âœï¸ Custom</button>
              </div>
            </div>
            <input type="hidden" id="type-select" value="break" />
            <div id="custom-title-popover" role="dialog" aria-label="Custom title" hidden>
              <div class="popover-row">
                <label for="custom-emoji-select">Emoji:</label>
                <div class="custom-dropdown emoji-dropdown" id="emoji-dropdown">
                  <button type="button" class="dropdown-trigger emoji-trigger" id="emoji-trigger">âœï¸</button>
                  <div class="dropdown-menu emoji-menu" id="emoji-menu" hidden>
                    <button type="button" class="dropdown-item emoji-item" data-value="âœï¸">âœï¸</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸš€">ğŸš€</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ’¡">ğŸ’¡</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ¯">ğŸ¯</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ”¥">ğŸ”¥</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="â­">â­</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ“š">ğŸ“š</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ“">ğŸ“</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ› ï¸">ğŸ› ï¸</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ’¬">ğŸ’¬</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ’»">ğŸ’»</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ–¥ï¸">ğŸ–¥ï¸</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="âŒ¨ï¸">âŒ¨ï¸</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ›">ğŸ›</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ”§">ğŸ”§</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="âš™ï¸">âš™ï¸</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ§ª">ğŸ§ª</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ”¬">ğŸ”¬</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ“Š">ğŸ“Š</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ“ˆ">ğŸ“ˆ</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ”’">ğŸ”’</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ”‘">ğŸ”‘</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ“¦">ğŸ“¦</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ—‚ï¸">ğŸ—‚ï¸</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ“‹">ğŸ“‹</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="âœ…">âœ…</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="âŒ">âŒ</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ”„">ğŸ”„</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="âš¡">âš¡</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸŒ">ğŸŒ</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ§˜">ğŸ§˜</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ§˜â€â™€ï¸">ğŸ§˜â€â™€ï¸</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸƒ">ğŸƒ</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="â˜•">â˜•</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸµ">ğŸµ</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ‰">ğŸ‰</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸŠ">ğŸŠ</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸŒŸ">ğŸŒŸ</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸµ">ğŸµ</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ§">ğŸ§</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ•">ğŸ•</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸŒˆ">ğŸŒˆ</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ˜´">ğŸ˜´</button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ§ ">ğŸ§ </button>
                    <button type="button" class="dropdown-item emoji-item" data-value="ğŸ’ª">ğŸ’ª</button>
                  </div>
                </div>
                <input type="hidden" id="custom-emoji-select" value="âœï¸" />
              </div>
              <div class="popover-row">
                <label for="custom-title-input">Title:</label>
                <input type="text" id="custom-title-input" placeholder="Enter title" maxlength="50" />
              </div>
              <button id="custom-title-ok">OK</button>
            </div>
          </div>
        </div>
      </div>
      <div id="action-buttons">
        <button id="start-pause-button">â–¶ï¸ Start</button>
        <button id="reset-button">ğŸ”„ Reset</button>
      </div>
      <div
        id="countdown"
        class="flex flex-1 w-full items-center justify-center"
      >
      </div>
      <footer id="timer-footer" class="w-full text-center py-4">
        <div class="flex items-center justify-center gap-2 text-sm">
          <span>Built with â¤ï¸ and âœ¨ by</span>
          <img src="/logo.png" alt="aatmmr" class="w-6 h-6 rounded-full inline-block" />
        </div>
      </footer>
    </section>
  </main>
</Layout>

<script>
  const countdownElement = document.getElementById("countdown")!;
  const timeSelect = document.getElementById("time-select")! as HTMLInputElement;
  const timeTrigger = document.getElementById("time-trigger")!;
  const timeMenu = document.getElementById("time-menu")!;
  const customMinutesInput = document.getElementById("custom-minutes")! as HTMLInputElement;
  const customTimePopover = document.getElementById("custom-time-popover")!;
  const customTimeOkButton = document.getElementById("custom-time-ok")!;
  const startPauseButton = document.getElementById("start-pause-button")!;
  const resetButton = document.getElementById("reset-button")!;
  const themeSwitch = document.getElementById("theme-switch")!;
  const targetTimeInput = document.getElementById("target-time")! as HTMLInputElement;
  const variantFixed = document.getElementById("variant-fixed")!;
  const variantTarget = document.getElementById("variant-target")!;
  const fixedSettings = document.getElementById("fixed-settings")!;
  const targetSettings = document.getElementById("target-settings")!;
  const typeSettings = document.getElementById("type-settings")!;
  const customTitlePopover = document.getElementById("custom-title-popover")!;
  const customTitleInput = document.getElementById("custom-title-input")! as HTMLInputElement;
  const customEmojiSelect = document.getElementById("custom-emoji-select")! as HTMLInputElement;
  const emojiTrigger = document.getElementById("emoji-trigger")!;
  const emojiMenu = document.getElementById("emoji-menu")!;
  const customTitleOkButton = document.getElementById("custom-title-ok")!;
  const typeSelect = document.getElementById("type-select")! as HTMLInputElement;
  const typeTrigger = document.getElementById("type-trigger")!;
  const typeMenu = document.getElementById("type-menu")!;

  const titleDefaults: Record<string, string> = {
    break: "Take a break and be back in...",
    lab: "Tinkering for another...",
    session: "Session starts in...",
    custom: "Custom"
  };
  let customTitle = "";
  let customEmoji = "âœï¸";
  let previousType = "break";

  const countdownDefaultText = "â±ï¸ time for...";
  const sessionStartingText = "Session starting soon...";
  const targetTimeErrorText = "âš ï¸ Target time must be in the future";

  let timerInterval: string | number | NodeJS.Timeout | undefined;
  let currentVariant: "fixed" | "target" = "fixed";
  let timerState: "idle" | "running" | "paused" = "idle";
  let remainingTime: number = 0;

  let initialTimeLeft: number = 0;

  function updateTimer(timeLeft: number) {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    const selectedType = typeSelect.value;
    const emoji = selectedType === "break" ? "â˜•ï¸" : selectedType === "lab" ? "ğŸ§‘â€ğŸ”¬" : selectedType === "session" ? "ğŸ“" : customEmoji;
    const title = selectedType === "custom" ? customTitle : titleDefaults[selectedType] || "Timer";
    const totalTime = initialTimeLeft > 0 ? initialTimeLeft : parseInt(timeSelect.value, 10);
    const progressPercentage = (timeLeft / totalTime) * 100;

    const segments = Array.from({ length: totalTime / 15 }, (_, i) => {
      const segmentPosition = (i / (totalTime / 15)) * 100;
      return `<div style="position: absolute; left: ${segmentPosition}%; width: 1px; height: 100%; background-color: #ffffff; z-index: 1;"></div>`;
    }).join("");

    countdownElement.innerHTML = `
      <div id="countdown-content">
        <div id="countdown-emoji">${emoji}</div>
        <div id="countdown-title">${title}</div>
        <div id="countdown-time">${minutes}:${seconds.toString().padStart(2, "0")}</div>
        <div id="progress-bar-container" style="position: relative; width: 80vw; height: 10px; background-color: #e0e0e0; margin-top: 10px;">
          ${segments}
          <div id="progress-bar" style="position: absolute; right: ${100 - progressPercentage}%; width: ${progressPercentage}%; height: 100%; background-color: #282728; z-index: 0;"></div>
        </div>
      </div>
    `;
  }

  function handleStartPause() {
    if (timerState === "idle") {
      startTimer();
    } else if (timerState === "running") {
      pauseTimer();
    } else if (timerState === "paused") {
      resumeTimer();
    }
  }

  function startTimer() {
    let timeLeft: number;

    // Check which variant is selected
    if (currentVariant === "target") {
      if (!targetTimeInput.value) {
        countdownElement.textContent = "âš ï¸ Please set a target time";
        setTimeout(() => {
          countdownElement.textContent = countdownDefaultText;
        }, 2000);
        return;
      }

      const now = new Date();
      const [hours, minutes] = targetTimeInput.value.split(":").map(Number);
      const targetDate = new Date();
      targetDate.setHours(hours, minutes, 0, 0);

      // Validate target time is in the future
      if (targetDate <= now) {
        countdownElement.textContent = targetTimeErrorText;
        setTimeout(() => {
          countdownElement.textContent = countdownDefaultText;
        }, 2000);
        return;
      }

      timeLeft = Math.floor((targetDate.getTime() - now.getTime()) / 1000);
    } else {
      // Check if "custom" is selected but no custom time has been set yet
      if (timeSelect.value === "custom") {
        countdownElement.textContent = "âš ï¸ Please set a custom time";
        setTimeout(() => {
          countdownElement.textContent = countdownDefaultText;
        }, 2000);
        return;
      }
      timeLeft = parseInt(timeSelect.value, 10);
    }

    initialTimeLeft = timeLeft;
    remainingTime = timeLeft;
    runTimer();
  }

  function runTimer() {
    timerState = "running";
    startPauseButton.textContent = "â¸ï¸ Pause";
    updateTimer(remainingTime);

    timerInterval = setInterval(() => {
      if (remainingTime > 0) {
        remainingTime -= 1;
        updateTimer(remainingTime);
      } else {
        clearInterval(timerInterval);
        timerState = "idle";
        countdownElement.textContent = sessionStartingText;
        startPauseButton.textContent = "â–¶ï¸ Start";
      }
    }, 1000);
  }

  function pauseTimer() {
    clearInterval(timerInterval);
    timerState = "paused";
    startPauseButton.textContent = "â–¶ï¸ Resume";
  }

  function resumeTimer() {
    runTimer();
  }

  function resetTimer() {
    clearInterval(timerInterval);
    targetTimeInput.value = "";
    resetCustomOption();
    timeSelect.value = "300";
    customMinutesInput.value = "";
    closeCustomTimePopover();
    currentVariant = "fixed";
    updateVariantUI();
    countdownElement.textContent = countdownDefaultText;
    timerState = "idle";
    startPauseButton.textContent = "â–¶ï¸ Start";
    initialTimeLeft = 0;
    remainingTime = 0;
    // Reset type and custom title
    resetCustomTypeOption();
    typeSelect.value = "break";
    typeTrigger.textContent = "â˜•ï¸ Break";
    customTitle = "";
    customEmoji = "âœï¸";
    customTitleInput.value = "";
    customEmojiSelect.value = "âœï¸";
    emojiTrigger.textContent = "âœï¸";
    closeCustomTitlePopover();
    previousType = "break";
    // Reset time dropdown
    timeSelect.value = "300";
    timeTrigger.textContent = "5 min";
    resetCustomOption();
  }

  function updateVariantUI() {
    if (currentVariant === "fixed") {
      variantFixed.classList.add("active");
      variantFixed.setAttribute("aria-pressed", "true");
      variantTarget.classList.remove("active");
      variantTarget.setAttribute("aria-pressed", "false");
      fixedSettings.hidden = false;
      targetSettings.hidden = true;
    } else {
      variantTarget.classList.add("active");
      variantTarget.setAttribute("aria-pressed", "true");
      variantFixed.classList.remove("active");
      variantFixed.setAttribute("aria-pressed", "false");
      fixedSettings.hidden = true;
      targetSettings.hidden = false;
    }
  }

  function openCustomTimePopover() {
    customTimePopover.hidden = false;
    customMinutesInput.focus();
  }

  function closeCustomTimePopover() {
    customTimePopover.hidden = true;
  }

  function applyCustomTime() {
    const customMinutes = parseInt(customMinutesInput.value, 10);
    if (customMinutes && customMinutes > 0) {
      // Update the hidden input value and trigger text
      timeSelect.value = (customMinutes * 60).toString();
      timeTrigger.textContent = `${customMinutes} min`;
      // Update the custom option in the menu
      const customItem = timeMenu.querySelector('[data-value="custom"]') as HTMLButtonElement;
      if (customItem) {
        customItem.dataset.value = timeSelect.value;
        customItem.textContent = `${customMinutes} min`;
      }
    }
    closeCustomTimePopover();
  }

  function resetCustomOption() {
    const customItem = timeMenu.querySelector('.dropdown-item:last-child') as HTMLButtonElement;
    if (customItem && customItem.textContent !== 'Custom') {
      customItem.dataset.value = 'custom';
      customItem.textContent = 'Custom';
    }
  }

  // Event listeners
  startPauseButton.addEventListener("click", handleStartPause);
  resetButton.addEventListener("click", resetTimer);

  variantFixed.addEventListener("click", () => {
    currentVariant = "fixed";
    closeCustomTimePopover(); // Close popover when switching variants
    updateVariantUI();
  });

  variantTarget.addEventListener("click", () => {
    currentVariant = "target";
    closeCustomTimePopover(); // Close popover when switching variants
    updateVariantUI();
  });

  // Time dropdown handling
  timeTrigger.addEventListener("click", (e) => {
    e.stopPropagation();
    closeAllDropdowns();
    timeMenu.hidden = !timeMenu.hidden;
  });

  timeMenu.querySelectorAll('.dropdown-item').forEach(item => {
    item.addEventListener('click', (e) => {
      const target = e.target as HTMLButtonElement;
      const value = target.dataset.value!;
      closeCustomTimePopover();
      if (value === 'custom') {
        openCustomTimePopover();
      } else {
        resetCustomOption();
        customMinutesInput.value = '';
        timeSelect.value = value;
        timeTrigger.textContent = target.textContent!;
      }
      timeMenu.hidden = true;
    });
  });

  customTimeOkButton.addEventListener("click", () => {
    applyCustomTime();
  });

  // Close popover when clicking outside
  document.addEventListener("click", (e) => {
    const target = e.target as Element;

    // Check if click is outside the fixed settings container
    if (!fixedSettings.contains(target) && !customTimePopover.hidden) {
      closeCustomTimePopover();
    }
  });

  // Handle Enter and Escape keys in custom minutes input
  customMinutesInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      applyCustomTime();
    } else if (e.key === "Escape") {
      closeCustomTimePopover();
    }
  });

  // Handle Escape key globally when popover is open
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && !customTimePopover.hidden) {
      closeCustomTimePopover();
    }
  });



  // Custom title popover functions
  function openCustomTitlePopover() {
    customTitlePopover.hidden = false;
    customTitleInput.focus();
  }

  function closeCustomTitlePopover() {
    customTitlePopover.hidden = true;
  }

  function applyCustomTitle() {
    const newCustomTitle = customTitleInput.value.trim();
    const newCustomEmoji = customEmojiSelect.value || "âœï¸";
    if (newCustomTitle) {
      customTitle = newCustomTitle;
      customEmoji = newCustomEmoji;
      typeSelect.value = "custom";
      // Update the trigger and menu item
      typeTrigger.textContent = `${newCustomEmoji} ${newCustomTitle}`;
      const customItem = typeMenu.querySelector('[data-value="custom"]') as HTMLButtonElement;
      if (customItem) {
        customItem.textContent = `${newCustomEmoji} ${newCustomTitle}`;
      }
    }
    closeCustomTitlePopover();
  }

  function resetCustomTypeOption() {
    const customItem = typeMenu.querySelector('[data-value="custom"]') as HTMLButtonElement;
    if (customItem) {
      customItem.textContent = 'âœï¸ Custom';
    }
  }

  // Type dropdown handling
  typeTrigger.addEventListener("click", (e) => {
    e.stopPropagation();
    closeAllDropdowns();
    typeMenu.hidden = !typeMenu.hidden;
  });

  typeMenu.querySelectorAll('.dropdown-item').forEach(item => {
    item.addEventListener('click', (e) => {
      const target = e.target as HTMLButtonElement;
      const value = target.dataset.value!;
      closeCustomTitlePopover();
      if (value === 'custom') {
        openCustomTitlePopover();
      } else {
        previousType = value;
        typeSelect.value = value;
        typeTrigger.textContent = target.textContent!;
      }
      typeMenu.hidden = true;
    });
  });

  customTitleOkButton.addEventListener("click", () => {
    applyCustomTitle();
  });

  // Close title popover when clicking outside
  document.addEventListener("click", (e) => {
    const target = e.target as Element;
    if (!typeSettings.contains(target) && !customTitlePopover.hidden) {
      closeCustomTitlePopover();
    }
  });

  // Handle Enter and Escape keys in custom title input
  customTitleInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      applyCustomTitle();
    } else if (e.key === "Escape") {
      closeCustomTitlePopover();
    }
  });

  // Handle Escape key globally when title popover is open
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && !customTitlePopover.hidden) {
      closeCustomTitlePopover();
    }
  });

  // Emoji dropdown handling
  emojiTrigger.addEventListener("click", (e) => {
    e.stopPropagation();
    emojiMenu.hidden = !emojiMenu.hidden;
  });

  emojiMenu.querySelectorAll('.dropdown-item').forEach(item => {
    item.addEventListener('click', (e) => {
      const target = e.target as HTMLButtonElement;
      const value = target.dataset.value!;
      customEmojiSelect.value = value;
      emojiTrigger.textContent = value;
      emojiMenu.hidden = true;
    });
  });

  // Close all dropdowns helper
  function closeAllDropdowns() {
    timeMenu.hidden = true;
    typeMenu.hidden = true;
    emojiMenu.hidden = true;
  }

  // Close dropdowns when clicking outside
  document.addEventListener("click", (e) => {
    const target = e.target as Element;
    if (!target.closest('.custom-dropdown')) {
      closeAllDropdowns();
    }
  });

  // Initial state
  countdownElement.textContent = countdownDefaultText;
  updateVariantUI();
  
  // Set target time to current hour
  const now = new Date();
  const currentHour = now.getHours().toString().padStart(2, '0');
  const currentMinute = now.getMinutes().toString().padStart(2, '0');
  targetTimeInput.value = `${currentHour}:${currentMinute}`;

  themeSwitch.addEventListener("click", () => {
    const currentTheme = document.documentElement.getAttribute("data-theme");
    const newTheme = currentTheme === "dark" ? "light" : "dark";
    document.documentElement.setAttribute("data-theme", newTheme);
    themeSwitch.textContent = newTheme === "dark" ? "â˜€ï¸" : "ğŸŒ";
  });
</script>